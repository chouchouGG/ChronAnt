<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--namespace: 命名空间，用于标识每一个Mapper XML文件中的语句，预防在不同的Mapper XML文件中存在相同的语句ID-->
<mapper namespace="cn.uhoc.infra.persistent.dao.ITaskDao">
    <!--resultType: 也称为自动映射，只有在表的列名与POJO类的属性完全一致时映射，会比较方便-->
    <resultMap id="resultMap" type="cn.uhoc.infra.persistent.po.Task">
        <result column="id" property="id"/>
        <result column="user_id" property="userId"/>
        <result column="task_id" property="taskId"/>
        <result column="task_type" property="taskType"/>
        <result column="task_stage" property="taskStage"/>
        <result column="status" property="status"/>
        <result column="crt_retry_num" property="crtRetryNum"/>
        <result column="max_retry_num" property="maxRetryNum"/>
        <result column="priority" property="orderTime"/>
        <result column="order_time" property="priority"/>
        <result column="max_retry_interval" property="maxRetryInterval"/>
        <result column="schedule_log" property="scheduleLog"/>
        <result column="task_context" property="taskContext"/>
        <result column="create_time" property="createTime"/>
        <result column="modify_time" property="modifyTime"/>
    </resultMap>
    <insert id="insertTask">
        insert into ${tableName} (`user_id`,
                                  `task_id`,
                                  `task_type`,
                                  `task_stage`,
                                  `status`,
                                  `crt_retry_num`,
                                  `max_retry_num`,
                                  `order_time`,
                                  `priority`,
                                  `max_retry_interval`,
                                  `schedule_log`,
                                  `task_context`,
                                  `create_time`,
                                  `modify_time`)
        VALUES (#{taskEntity.user_id},
                #{taskEntity.task_id},
                #{taskEntity.task_type},
                #{taskEntity.task_stage},
                #{taskEntity.status},
                #{taskEntity.crt_retry_num},
                #{taskEntity.max_retry_num},
                now(),
                #{taskEntity.priority},
                #{taskEntity.max_retry_interval},
                #{taskEntity.schedule_log},
                #{taskEntity.task_context},
                now(),
                now())
    </insert>
    <!--TODO 学习Mybatis-->
    <update id="updateStatusBatch">
        update ${tableName} set status = #{status}, modify_time = now()
        where task_id in
        <foreach collection="taskIds" item="taskId" index="index"
                 open="(" close=")" separator=",">
            #{taskId}
        </foreach>
    </update>
    <update id="updateTask" parameterType="">
        update ${tableName}
        set user_id = #{taskEntity.user_id},
            task_stage = #{taskEntity.task_stage},
            status = #{taskEntity.status},
            crt_retry_num = #{taskEntity.crt_retry_num},
            max_retry_num = #{taskEntity.max_retry_num},
            max_retry_interval = #{taskEntity.max_retry_interval},
            schedule_log = #{taskEntity.schedule_log},
            task_context = #{taskEntity.task_context},
            create_time = #{taskEntity.create_time},
            modify_time = now(),
            order_time = #{taskEntity.order_time}
        where task_id = #{taskEntity.task_id}
        and status not in
            <foreach collection="statusList" item="status" index="index" open="(" close=")" separator=",">
                #{status}
            </foreach>
    </update>
    <select id="getTaskList" resultMap="resultMap">
        select *
        from ${tableName}
        where task_type = #{taskType}
          and status = #{status}
        order by order_time
        limit #{limit}
    </select>
    <select id="getTaskById" resultMap="resultMap">
        select *
        from ${tableName}
        where task_id = #{task_id}
    </select>
    <select id="getTaskByUseridAndStatus" resultMap="resultMap">
        select *
        from ${tableName}
        where user_id = #{user_id}
        and status in
        <foreach collection="statusList" item="status" index="index" open="(" close=")" separator=",">
            #{status}
        </foreach>
    </select>


</mapper>